input {
  file {
    path => "/app/logs/test.log"
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/sincedb"
    type => "bookservice-http"
  }
  # Application logs disabled - only HTTP request logs are sent to Elasticsearch
  # The bookservice.log file is still available locally for debugging
  # file {
  #   path => "/app/logs/bookservice.log"
  #   start_position => "beginning"
  #   sincedb_path => "/dev/null"
  #   type => "bookservice-app"
  # }
}

filter {
  if [type] == "bookservice-http" {
    grok {
      match => {
        "message" => "%{TIMESTAMP_ISO8601:timestamp} \| %{DATA:protocol} \| %{WORD:method} %{URIPATH:endpoint} \| Status: %{NUMBER:status_code:int} \| Duration: %{NUMBER:duration:int}ms \| IP: %{IP:client_ip}"
      }
    }
    date {
      match => ["timestamp", "yyyy-MM-dd HH:mm:ss"]
      target => "@timestamp"
    }
    mutate {
      add_field => { "service" => "bookservice" }
      add_field => { "log_type" => "http_request" }
      remove_field => [ "timestamp" ]
    }
    if [status_code] >= 400 and [status_code] < 500 {
      mutate { add_field => { "status_category" => "client_error" } }
    } else if [status_code] >= 500 {
      mutate { add_field => { "status_category" => "server_error" } }
    } else if [status_code] >= 200 and [status_code] < 300 {
      mutate { add_field => { "status_category" => "success" } }
    } else {
      mutate { add_field => { "status_category" => "other" } }
    }
  }

  if [type] == "bookservice-app" {
    grok {
      match => {
        "message" => "%{TIMESTAMP_ISO8601:timestamp} +%{LOGLEVEL:log_level} +%{NUMBER:pid} --- \[%{DATA:app_name}\] \[%{DATA:thread}\] +%{NOTSPACE:logger} +: %{GREEDYDATA:log_message}"
      }
    }
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }
    mutate {
      add_field => { "service" => "bookservice" }
      add_field => { "log_type" => "application" }
      remove_field => [ "timestamp" ]
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "bookservice-logs-%{+YYYY.MM.dd}"
  }
  stdout {
    codec => rubydebug
  }
}
